# ๐ Diagrama de Flujo - Impresiรณn de Tickets

## Flujo Completo de Impresiรณn Automรกtica

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   USUARIO EN POS                            โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1. Toma pedido y selecciona productos                      โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2. Click en "Procesar Pago"                                โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  3. PaymentMethodDialog se abre                             โ
โ     - Selecciona mรฉtodo de pago                             โ
โ     - Confirma monto                                        โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  4. Click en "Procesar Pago"                                โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ค FRONTEND: Llama a PagoService.crearPagoCompleto()      โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ API: POST /api/v1/pagos/completo                       โ
โ     Body: { idPedido, idMetodo, monto, referencia }        โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฅ๏ธ BACKEND:                                                โ
โ     1. Crea registro de pago                                โ
โ     2. Actualiza estado del pedido โ PAGADO                 โ
โ     3. Genera comprobante automรกticamente                   โ
โ     4. Crea archivos PDF (ticket + A4)                      โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐จ Respuesta del Backend:                                  โ
โ  {                                                          โ
โ    success: true,                                           โ
โ    data: {                                                  โ
โ      pago: { ... },                                         โ
โ      comprobante: {                                         โ
โ        idComprobante: 123,                                  โ
โ        numeroComprobante: "T001-00000001",                  โ
โ        archivoTicketDisponible: true,                       โ
โ        archivoPdfDisponible: true                           โ
โ      }                                                      โ
โ    }                                                        โ
โ  }                                                          โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฑ FRONTEND: Recibe respuesta                              โ
โ     - Emite evento 'pago-completado'                        โ
โ     - Emite evento 'comprobante-generado'                   โ
โ     - Guarda en ultimoComprobante.value                     โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โฑ๏ธ setTimeout(1000ms) - Esperar que archivo estรฉ listo    โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐จ๏ธ useTicketPrinter.imprimirTicket()                      โ
โ     - idComprobante: 123                                    โ
โ     - autoImprimir: true                                    โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ API: GET /api/v1/comprobantes/123/ticket/imprimir      โ
โ     Headers: Authorization: Bearer {token}                  โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฅ๏ธ BACKEND Responde:                                       โ
โ     - Content-Type: application/pdf                         โ
โ     - Content-Disposition: inline                           โ
โ     - X-Auto-Print: true                                    โ
โ     - Body: [PDF Binary Data]                               โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฑ FRONTEND Recibe Blob                                    โ
โ     const blob = response.data;                             โ
โ     const url = URL.createObjectURL(blob);                  โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ช Crear Iframe Oculto                                     โ
โ     const iframe = document.createElement('iframe');        โ
โ     iframe.style.display = 'none';                          โ
โ     iframe.src = url;                                       โ
โ     document.body.appendChild(iframe);                      โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โฑ๏ธ iframe.onload โ setTimeout(500ms)                       โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐จ๏ธ iframe.contentWindow.print()                           โ
โ     - Abre diรกlogo de impresiรณn del navegador               โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐จ๏ธ DIรLOGO DEL NAVEGADOR                                  โ
โ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ              โ
โ     โ  Imprimir                             โ              โ
โ     โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ              โ
โ     โ  Impresora: [Tรฉrmica 80mm โผ]         โ              โ
โ     โ  Copias: [1]                          โ              โ
โ     โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ              โ
โ     โ  [ Cancelar ]  [ Imprimir ]           โ              โ
โ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ              โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ Usuario imprime o cancela                               โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐งน Cleanup (despuรฉs de 1 segundo)                          โ
โ     - document.body.removeChild(iframe)                     โ
โ     - URL.revokeObjectURL(url)                              โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฌ Mostrar diรกlogo con comprobante generado                โ
โ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ     โ  โ Comprobante generado                      โ      โ
โ     โ  T001-00000001                                โ      โ
โ     โ                                               โ      โ
โ     โ  [๐จ๏ธ Imprimir Ticket] [๐ฅ Descargar]          โ      โ
โ     โ  [๐ Imprimir PDF]                            โ      โ
โ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Flujo de Descarga (Sin Impresiรณn)

```
Usuario Click "Descargar Ticket"
         โ
         โผ
GET /api/v1/comprobantes/{id}/ticket
         โ
         โผ
Blob con Content-Disposition: attachment
         โ
         โผ
ComprobanteService.downloadFile(blob, filename)
         โ
         โผ
Navegador descarga automรกticamente el archivo
         โ
         โผ
Usuario guarda en disco
```

## Comparaciรณn de Endpoints

### Endpoint `/ticket` (Descarga)
```
Request:  GET /api/v1/comprobantes/123/ticket
Response Headers:
  Content-Type: application/pdf
  Content-Disposition: attachment; filename="ticket_T001-00000001.pdf"

Comportamiento: Navegador descarga automรกticamente
```

### Endpoint `/ticket/imprimir` (Impresiรณn)
```
Request:  GET /api/v1/comprobantes/123/ticket/imprimir
Response Headers:
  Content-Type: application/pdf
  Content-Disposition: inline; filename="ticket_T001-00000001.pdf"
  X-Auto-Print: true

Comportamiento: Se abre inline (en iframe) para imprimir
```

## Flujo de Manejo de Errores

```
imprimirTicket()
     โ
     โผ
try { obtenerTicketParaImprimir() }
     โ
     โโ โ Success
     โ   โโ> Crear iframe โ print()
     โ
     โโ โ Error
         โ
         โผ
     catch (error)
         โ
         โโ> error.value = error.message
         โโ> printing.value = false
         โโ> return false
              โ
              โผ
         Usuario ve error en snackbar
              โ
              โผ
         Opciรณn manual de descarga disponible
```

## Timeline de Ejecuciรณn

```
t=0ms     Usuario click "Procesar Pago"
          โ
t=100ms   API call POST /pagos/completo
          โ
t=800ms   Backend responde con comprobante
          โ
t=1000ms  setTimeout espera (archivo listo)
          โ
t=1100ms  GET /ticket/imprimir
          โ
t=1300ms  Blob recibido
          โ
t=1400ms  Iframe creado y PDF cargado
          โ
t=1900ms  iframe.onload + setTimeout(500ms)
          โ
t=1900ms  ๐จ๏ธ Diรกlogo de impresiรณn se abre
          โ
t=2900ms  Cleanup (removeChild + revokeURL)
```

## Estados del Sistema

| Estado | Descripciรณn | UI |
|--------|-------------|-----|
| `idle` | Sin operaciรณn en curso | Botones habilitados |
| `processing` | Creando pago | Loading en botรณn "Procesar Pago" |
| `printing` | Imprimiendo ticket | Loading en botones de impresiรณn |
| `success` | Completado exitosamente | Dialog con opciones |
| `error` | Error en operaciรณn | Snackbar con mensaje de error |

## Puntos Crรญticos de Fallo

1. **โ Token expirado** โ Interceptor refresca automรกticamente
2. **โ Archivo no disponible** โ Backend responde 404
3. **โ CORS bloqueado** โ Verificar configuraciรณn del servidor
4. **โ Bloqueador de popups** โ Usuario debe permitir ventanas emergentes
5. **โ Impresora no configurada** โ Diรกlogo del navegador permite seleccionar
