<template>
  <v-container fluid>
    <!-- Header del Dashboard -->
    <v-row class="mb-6">
      <v-col cols="12">
        <v-card class="dashboard-header" elevation="0">
          <v-card-text class="pa-6">
            <v-row align="center">
              <v-col cols="12" md="auto">
                <div class="d-flex align-center">
                  <img
                    src="/logo_mozaico.png"
                    alt="Mozaico Logo"
                    class="dashboard-logo me-4"
                  />
                  <div>
                    <h1 class="text-h4 font-weight-bold mb-1 dashboard-title">
                      Panel de Control
                    </h1>
                    <p class="text-subtitle-1 text-medium-emphasis mb-0">
                      Bienvenido a Mozaico
                    </p>
                  </div>
                </div>
              </v-col>
              <v-spacer class="d-none d-md-block" />
              <v-col cols="12" md="auto">
                <div class="d-flex align-center ga-2">
                  <v-chip
                    color="#6B8E5C"
                    variant="flat"
                    size="small"
                    class="font-weight-medium"
                  >
                    <v-icon start size="small">mdi-clock-outline</v-icon>
                    {{ currentTime }}
                  </v-chip>
                  <v-chip
                    color="#D4A03E"
                    variant="flat"
                    size="small"
                    class="font-weight-medium"
                  >
                    <v-icon start size="small">mdi-calendar-today</v-icon>
                    {{ currentDate }}
                  </v-chip>
                </div>
              </v-col>
            </v-row>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>

    <!-- Información de Empresa -->
    <v-row class="mb-6">
      <v-col cols="12" lg="6">
        <EmpresaInfo />
      </v-col>
      <v-col cols="12" lg="6">
        <CarritoCalculadora
          :productos="productosEjemplo"
          @procesar-pedido="procesarPedidoEjemplo"
        />
      </v-col>
    </v-row>

    <!-- Tarjetas de resumen -->
    <v-row class="mb-6">
      <v-col v-for="card in summaryCards" :key="card.title" cols="12" sm="6" md="3">
        <v-card class="h-100" elevation="2">
          <v-card-text class="pb-0">
            <div class="d-flex align-center justify-space-between">
              <div>
                <p class="text-caption text-medium-emphasis mb-1">{{ card.title }}</p>
                <h2 class="text-h4 font-weight-bold">{{ card.value }}</h2>
                <div class="d-flex align-center mt-2">
                  <v-icon :color="card.trend > 0 ? 'success' : 'error'" size="16" class="me-1">
                    {{ card.trend > 0 ? 'mdi-trending-up' : 'mdi-trending-down' }}
                  </v-icon>
                  <span :class="card.trend > 0 ? 'text-success' : 'text-error'" class="text-caption">
                    {{ Math.abs(card.trend) }}%
                  </span>
                </div>
              </div>
              <v-avatar :color="card.color" size="56">
                <v-icon color="white" size="24">{{ card.icon }}</v-icon>
              </v-avatar>
            </div>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>

    <!-- Gráficos principales -->
    <v-row class="mb-6">
      <v-col cols="12" lg="8">
        <SalesChart />
      </v-col>
      <v-col cols="12" lg="4">
        <InventoryChart />
      </v-col>
    </v-row>

    <!-- Gráficos secundarios y actividad reciente -->
    <v-row>
      <v-col cols="12" md="8">
        <OrdersChart />
      </v-col>

      <v-col cols="12" md="4">
        <v-card elevation="2" class="h-100">
          <v-card-title>
            <v-icon class="me-2">mdi-history</v-icon>
            Actividad Reciente
          </v-card-title>
          <v-card-text>
            <v-list density="compact">
              <v-list-item
                v-for="activity in recentActivity"
                :key="activity.id"
                :prepend-icon="activity.icon"
                :title="activity.title"
                :subtitle="activity.time"
                class="px-0"
              >
                <template v-slot:prepend>
                  <v-avatar size="32" :color="activity.color">
                    <v-icon size="16" color="white">{{ activity.icon }}</v-icon>
                  </v-avatar>
                </template>
              </v-list-item>
            </v-list>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>

    <!-- Sección de accesos rápidos -->
    <v-row class="mt-6">
      <v-col cols="12">
        <h2 class="text-h5 mb-4">Accesos Rápidos</h2>
      </v-col>
      <v-col v-for="quickAccess in quickActions" :key="quickAccess.title" cols="12" sm="6" md="3">
        <v-card
          class="h-100 cursor-pointer"
          elevation="2"
          hover
          @click="() => $router.push(quickAccess.to)"
        >
          <v-card-text class="text-center pa-6">
            <v-avatar size="48" :color="quickAccess.color" class="mb-3">
              <v-icon color="white" size="24">{{ quickAccess.icon }}</v-icon>
            </v-avatar>
            <h3 class="text-h6 mb-2">{{ quickAccess.title }}</h3>
            <p class="text-caption text-medium-emphasis">{{ quickAccess.description }}</p>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>
  </v-container>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted } from 'vue';
import { useRouter } from 'vue-router';
import EmpresaInfo from '@/components/common/EmpresaInfo.vue';
import CarritoCalculadora from '@/components/common/CarritoCalculadora.vue';
import SalesChart from '@/components/dashboard/SalesChart.vue';
import OrdersChart from '@/components/dashboard/OrdersChart.vue';
import InventoryChart from '@/components/dashboard/InventoryChart.vue';
import type { ProductoCarrito } from '@/types/empresa';
import { usePedidoStore } from '@/stores/pedidoStore';
import { useMesaStore } from '@/stores/mesaStore';
import { useClienteStore } from '@/stores/clienteStore';

const $router = useRouter();
const pedidoStore = usePedidoStore();
const mesaStore = useMesaStore();
const clienteStore = useClienteStore();

// Hora y fecha actual
const currentTime = ref('');
const currentDate = ref('');
let timeInterval: number;

const updateTime = () => {
  const now = new Date();
  currentTime.value = now.toLocaleTimeString('es-PE', {
    hour: '2-digit',
    minute: '2-digit'
  });
  currentDate.value = now.toLocaleDateString('es-PE', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  });
};

// Cargar datos en el mount
onMounted(async () => {
  updateTime();
  timeInterval = window.setInterval(updateTime, 1000);

  await Promise.all([
    pedidoStore.fetchPedidos(),
    mesaStore.fetchMesas(),
    clienteStore.fetchClientes()
  ]);
});

onUnmounted(() => {
  if (timeInterval) {
    clearInterval(timeInterval);
  }
});

// Tarjetas de resumen con datos reales
const summaryCards = computed(() => {
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);

  // Contar pedidos de hoy
  const pedidosHoy = pedidoStore.pedidos.filter(p => {
    const fechaPedido = new Date(p.fechaPedido);
    return fechaPedido >= hoy;
  }).length;

  // Calcular ventas de hoy (solo pedidos PAGADO)
  const ventasHoy = pedidoStore.pedidos
    .filter(p => {
      const fechaPedido = new Date(p.fechaPedido);
      return fechaPedido >= hoy && (p.estado === 'PAGADO' || p.estado === 'ATENDIDO');
    })
    .reduce((sum, p) => sum + (p.total || 0), 0);

  // Contar mesas ocupadas
  const mesasOcupadas = mesaStore.mesas.filter(m => m.estado === 'OCUPADA').length;
  const totalMesas = mesaStore.mesas.length;

  // Contar clientes activos
  const clientesActivos = clienteStore.clientes.filter(c => c.activo).length;

  return [
    {
      title: 'Pedidos Hoy',
      value: pedidosHoy.toString(),
      trend: 8.2,
      icon: 'mdi-clipboard-list',
      color: '#2C3E50'
    },
    {
      title: 'Ventas Hoy',
      value: `S/ ${ventasHoy.toFixed(2)}`,
      trend: 12.5,
      icon: 'mdi-cash',
      color: '#6B8E5C'
    },
    {
      title: 'Mesas Ocupadas',
      value: `${mesasOcupadas}/${totalMesas}`,
      trend: mesasOcupadas > totalMesas / 2 ? 5.1 : -2.3,
      icon: 'mdi-table-chair',
      color: '#D4A03E'
    },
    {
      title: 'Clientes Activos',
      value: clientesActivos.toString(),
      trend: 3.7,
      icon: 'mdi-account-group',
      color: '#C85A4A'
    }
  ];
});

const recentActivity = ref([
  {
    id: 1,
    title: 'Nuevo pedido - Mesa 5',
    time: 'Hace 2 minutos',
    icon: 'mdi-plus-circle',
    color: '#6B8E5C'
  },
  {
    id: 2,
    title: 'Pago procesado - S/45.80',
    time: 'Hace 5 minutos',
    icon: 'mdi-credit-card',
    color: '#2C3E50'
  },
  {
    id: 3,
    title: 'Mesa 3 liberada',
    time: 'Hace 8 minutos',
    icon: 'mdi-check-circle',
    color: '#D4A03E'
  },
  {
    id: 4,
    title: 'Stock bajo: Tomates',
    time: 'Hace 15 minutos',
    icon: 'mdi-alert-circle',
    color: '#C85A4A'
  },
  {
    id: 5,
    title: 'Nueva reserva para mañana',
    time: 'Hace 30 minutos',
    icon: 'mdi-calendar-plus',
    color: '#2C3E50'
  }
]);

// Datos de ejemplo para la calculadora
const productosEjemplo = ref<ProductoCarrito[]>([
  {
    id: 1,
    nombre: 'Hamburguesa Clásica',
    precio: 12.00,
    cantidad: 1,
    subtotal: 12.00
  },
  {
    id: 2,
    nombre: 'Coca-Cola',
    precio: 2.50,
    cantidad: 2,
    subtotal: 5.00
  },
  {
    id: 3,
    nombre: 'Papas Fritas',
    precio: 6.00,
    cantidad: 1,
    subtotal: 6.00
  }
]);

// Función para procesar pedido de ejemplo
const procesarPedidoEjemplo = () => {
  console.log('🛒 Procesando pedido de ejemplo con productos:', productosEjemplo.value);
  // Aquí iría la lógica real de procesamiento
  alert('Pedido procesado correctamente (ejemplo)');
};

const quickActions = ref([
  {
    title: 'Nuevo Pedido',
    description: 'Crear un nuevo pedido',
    icon: 'mdi-plus-circle',
    color: '#2C3E50',
    to: '/pedidos'
  },
  {
    title: 'Ver Mesas',
    description: 'Estado de las mesas',
    icon: 'mdi-table-chair',
    color: '#6B8E5C',
    to: '/mesas'
  },
  {
    title: 'Inventario',
    description: 'Gestionar stock',
    icon: 'mdi-package-variant',
    color: '#D4A03E',
    to: '/inventario'
  },
  {
    title: 'Reportes',
    description: 'Ver estadísticas',
    icon: 'mdi-chart-bar',
    color: '#C85A4A',
    to: '/reportes'
  }
]);
</script>

<style scoped>
.cursor-pointer {
  cursor: pointer;
}

.h-100 {
  height: 100%;
}

/* Dashboard Header */
.dashboard-header {
  background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
  border-radius: 16px;
  border: 1px solid rgba(44, 62, 80, 0.08);
  box-shadow: 0 2px 12px rgba(44, 62, 80, 0.06);
}

.dashboard-logo {
  width: 80px;
  height: 80px;
  object-fit: contain;
  flex-shrink: 0;
}

.dashboard-title {
  color: #2C3E50;
  letter-spacing: -0.5px;
}

/* Summary Cards */
:deep(.v-card) {
  border-radius: 12px;
  transition: all 0.3s ease;
}

:deep(.v-card:hover) {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(44, 62, 80, 0.12);
}

/* Quick Actions Cards */
:deep(.cursor-pointer.v-card) {
  border: 1px solid rgba(44, 62, 80, 0.08);
}

:deep(.cursor-pointer.v-card:hover) {
  border-color: rgba(44, 62, 80, 0.15);
  transform: translateY(-6px);
}

/* Activity Icons */
:deep(.v-list-item) {
  border-radius: 8px;
  margin-bottom: 4px;
}

:deep(.v-list-item:hover) {
  background-color: rgba(44, 62, 80, 0.03);
}

/* Chips personalizados */
:deep(.v-chip) {
  font-weight: 600;
  letter-spacing: 0.3px;
}

/* Responsive */
@media (max-width: 959px) {
  .dashboard-header {
    padding: 1rem !important;
  }

  .dashboard-logo {
    width: 60px;
    height: 60px;
  }

  .dashboard-title {
    font-size: 1.75rem !important;
  }
}

@media (max-width: 599px) {
  :deep(.v-card-text) {
    padding: 1rem !important;
  }

  .dashboard-logo {
    width: 50px;
    height: 50px;
  }

  .dashboard-title {
    font-size: 1.5rem !important;
  }
}
</style>
